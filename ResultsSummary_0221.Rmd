---
title: "Cell-type specific mediation project update"
author: "Andrea Lane"
date: "2/24/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(kableExtra)
```

## Outline

1. Project idea
2. EM initial value comparison
3. Bootstrap results using true values as initial values
4. Next steps

## Project idea reminder
\begin{align*}
Y~&\sim~ N(\theta_0 + \theta_1 E + \sum_k \theta_2^k m_{k}, ~\gamma^2)\\
M~&\sim~ N(\sum_{k}m_{k}\pi_{k}, ~\sigma^2) \\
m_{k}~&\sim~N(\beta_0^k + \beta_1^k E, ~\tau_{k}^2)
\end{align*}

 - Use TOAST to get $\beta$ initial values and reduce number of sites to go through EM
 - Run EM algorithm one site at a time to get estimates of $\Theta$
 - Calculate observed indirect effect $\hat{\beta_1}\hat{\theta_2}$
 - Use percentile bootstrap to assess significance of the indirect effect for each site and cell type
 

 
\newpage

## EM initial values

To evaluate the estimates obtained from EM depending on the initial values, I varied the mediating cell type and looked at 2 different mediating CpG sites. I used 4 different initial value cases (note that the true value for the mediating $\theta_2^k=0.4$):

 - Case 1: 0 for all $\theta_2^k$
 - Case 2: 0.2 for all $\theta_2^k$
 - Case 3: 0.1 for non-mediating cell types, 0.3 for mediating cell type
 - Case 4: 0 for non-mediating cell types, 0.4 for mediating cell type (true values)

```{r, echo=FALSE}
setwd("/Users/andrealane/Dropbox/CelltypeSpecificMediation/Simulation/dissertation/")

load("InitialValueAnalysis.RData")

par(mfrow=c(2,1), mai=c(0.8,0.8,0.3,0.5))

plot(site9cell1.lowvar[,1],ylim=c(0,1),pch=15,col="red",xaxt="n",ylab="Theta 2 estimate",xlab="",main="Mediating cell estimates for each cell type - Site 1",type="b",lty=1)
lines(site9cell2.lowvar[,2],pch=16,col="blue",type="b",lty=1)
lines(site9cell3.lowvar[,3],pch=17,col="green",type="b",lty=1)
lines(site9cell4.lowvar[,4],pch=18,col="black",type="b",lty=1)
abline(h=0.4,col="black")
axis(side = 1, at = seq(0, 4, by = 1))
legend(1, 1, legend=c("Cell 1", "Cell 2", "Cell 3", "Cell 4"),
       col=c("red","blue","green","black"), pch=c(15,16,17,18), horiz = TRUE)

plot(site5cell1.lowvar[,1],ylim=c(0,1),pch=15,col="red",xaxt="n",ylab="Theta 2 estimate",xlab="Initial value case",main="Mediating cell estimates for each cell type - Site 2",type="b",lty=1)
lines(site5cell2.lowvar[,2],pch=16,col="blue",type="b",lty=1)
lines(site5cell3.lowvar[,3],pch=17,col="green",type="b",lty=1)
lines(site5cell4.lowvar[,4],pch=18,col="black",type="b",lty=1)
abline(h=0.4,col="black")
axis(side = 1, at = seq(0, 4, by = 1))

```


\newpage 

Non-mediating cell type estimates (true value 0 in all cases)

 - Case 1: 0 for all $\theta_2^k$
 - Case 2: 0.2 for all $\theta_2^k$
 - Case 3: 0.1 for non-mediating cell types, 0.3 for mediating cell type
 - Case 4: 0 for non-mediating cell types, 0.4 for mediating cell type (true values)



```{r, echo=FALSE}
par(mfrow=c(4,2), mai=c(0.1,0.3,0.1,0.3))

plot(site9cell1.lowvar[,2],ylim=c(-1,1),pch=16,col="blue",xaxt="n",ylab="Theta 2 estimate",xlab="",type="b",lty=1)
abline(h=0,col="black")
lines(site9cell1.lowvar[,3],pch=17,col="green",type="b",lty=1)
lines(site9cell1.lowvar[,4],pch=18,col="black",type="b",lty=1)
legend(1, 1, legend=c("Cell 2", "Cell 3", "Cell 4"),
       col=c("blue","green","black"), pch=c(16,17,18),horiz =TRUE)
mtext("Cell 1 mediator - Site 1", side=3, line=0,cex=0.5)

plot(site5cell1.lowvar[,2],ylim=c(-1,1),pch=16,col="blue",xaxt="n",ylab="",xlab="",type="b",lty=1)
abline(h=0,col="black")
lines(site5cell1.lowvar[,3],pch=17,col="green",type="b",lty=1)
lines(site5cell1.lowvar[,4],pch=18,col="black",type="b",lty=1)
mtext("Cell 1 mediator - Site 2", side=3, line=0,cex=0.5)



plot(site9cell2.lowvar[,1],ylim=c(-1,1),pch=15,col="red",xaxt="n",ylab="Theta 2 estimate",xlab="",type="b",lty=1)
abline(h=0,col="black")
lines(site9cell2.lowvar[,3],pch=17,col="green",type="b",lty=1)
lines(site9cell2.lowvar[,4],pch=18,col="black",type="b",lty=1)
legend(1, 1, legend=c("Cell 1", "Cell 3", "Cell 4"),
       col=c("red","green","black"), pch=c(15,17,18),horiz =TRUE)
mtext("Cell 2 mediator - Site 1", side=3, line=0,cex=0.5)


plot(site5cell2.lowvar[,1],ylim=c(-1,1),pch=15,col="red",xaxt="n",ylab="",xlab="",type="b",lty=1)
abline(h=0,col="black")
lines(site5cell2.lowvar[,3],pch=17,col="green",type="b",lty=1)
lines(site5cell2.lowvar[,4],pch=18,col="black",type="b",lty=1)
mtext("Cell 2 mediator - Site 2", side=3, line=0,cex=0.5)



plot(site9cell3.lowvar[,1],ylim=c(-1,1),pch=15,col="red",xaxt="n",ylab="Theta 2 estimate",xlab="",type="b",lty=1)
abline(h=0,col="black")
lines(site9cell3.lowvar[,2],pch=16,col="blue",type="b",lty=1)
lines(site9cell3.lowvar[,4],pch=18,col="black",type="b",lty=1)
legend(1, 1, legend=c("Cell 1", "Cell 2", "Cell 4"),
       col=c("red","blue","black"), pch=c(15,16,18),horiz =TRUE)
mtext("Cell 3 mediator - Site 1", side=3, line=0,cex=0.5)



plot(site5cell3.lowvar[,1],ylim=c(-1,1),pch=15,col="red",xaxt="n",ylab="",xlab="",type="b",lty=1)
abline(h=0,col="black")
lines(site5cell3.lowvar[,2],pch=16,col="blue",type="b",lty=1)
lines(site5cell3.lowvar[,4],pch=18,col="black",type="b",lty=1)
mtext("Cell 3 mediator - Site 2", side=3, line=0,cex=0.5)



plot(site9cell4.lowvar[,1],ylim=c(-1,1),pch=15,col="red",xaxt="n",ylab="Theta 2 estimate",xlab="",type="b",lty=1)
abline(h=0,col="black")
lines(site9cell4.lowvar[,2],pch=16,col="blue",type="b",lty=1)
lines(site9cell4.lowvar[,3],pch=17,col="green",type="b",lty=1)
legend(1, 1, legend=c("Cell 1", "Cell 2", "Cell 3"),
       col=c("red","blue","green"), pch=c(15,16,17),horiz =TRUE)
mtext("Cell 4 mediator - Site 1", side=3, line=0,cex=0.5)


plot(site5cell4.lowvar[,1],ylim=c(-1,1),pch=15,col="red",xaxt="n",ylab="",xlab="",type="b",lty=1)
abline(h=0,col="black")
lines(site5cell4.lowvar[,2],pch=16,col="blue",type="b",lty=1)
lines(site5cell4.lowvar[,3],pch=17,col="green",type="b",lty=1)
mtext("Cell 4 mediator - Site 2", side=3, line=0,cex=0.5)


```


Comments:

 - for the most part, it seems case 3 and case 4 results are pretty similar, which is good.
 - I don't understand what causes differences between sites? For example in the top row of the non-mediator plots, the two sites are quite different. **See next page**

\newpage

The difference in the results for the sites comes from the number of mediating sites. The outcome $Y$ is generated by a linear combination of all of the mediating sites, even though EM is used for each site individually. Therefore, the relationship between the mediator and the outcome becomes weaker as the number of mediating sites increases.

The plots below show the estimates from EM for the mediating and non-mediating cell types when site A (site 2 from previous page) is the only mediating site, when it is one of two mediating sites, and one of four mediating sites.

Here, cell type 1 is the mediating cell type. Cell type 1 has the lowest proportion so this is sort of a "worst case scenario."

```{r, echo=FALSE}
load("SiteDifference.RData")

par(mfrow=c(3,2), mai=c(0.1,0.3,0.1,0.3))

plot(site5ONLY[,1],ylim=c(0,1.5),pch=16,col="blue",xaxt="n",ylab="Theta 2 estimate",xlab="",type="b",lty=1)
abline(h=0.4,col="black")
mtext("Site A by itself - mediating site", side=3, line=0,cex=0.5)

plot(site5ONLY[,2],ylim=c(-4,4),pch=16,col="green",xaxt="n",ylab="",xlab="",type="b",lty=1)
abline(h=0,col="black")
lines(site5ONLY[,3],pch=17,col="red",type="b",lty=1)
lines(site5ONLY[,4],pch=18,col="black",type="b",lty=1)
legend(1, 4, legend=c("Cell 2", "Cell 3", "Cell 4"),
       col=c("green","red","black"), pch=c(16,17,18),horiz =TRUE)
mtext("Site A by itself - non-mediating sites", side=3, line=0,cex=0.5)

plot(site5with9[,1],ylim=c(0,1.5),pch=16,col="blue",xaxt="n",ylab="Theta 2 estimate",xlab="",type="b",lty=1)
abline(h=0.4,col="black")
mtext("Site A with 1 other site - mediating site", side=3, line=0,cex=0.5)

plot(site5with9[,2],ylim=c(-4,4),pch=16,col="green",xaxt="n",ylab="",xlab="",type="b",lty=1)
abline(h=0,col="black")
lines(site5with9[,3],pch=17,col="red",type="b",lty=1)
lines(site5with9[,4],pch=18,col="black",type="b",lty=1)
legend(1, 4, legend=c("Cell 2", "Cell 3", "Cell 4"),
       col=c("green","red","black"), pch=c(16,17,18),horiz =TRUE)
mtext("Site A with 1 other site - non-mediating sites", side=3, line=0,cex=0.5)

plot(site5with4sites[,1],ylim=c(0,1.5),pch=16,col="blue",xaxt="n",ylab="Theta 2 estimate",xlab="",type="b",lty=1)
abline(h=0.4,col="black")
mtext("Site A with 3 other sites - mediating site", side=3, line=0,cex=0.5)

plot(site5with4sites[,2],ylim=c(-4,4),pch=16,col="green",xaxt="n",ylab="",xlab="",type="b",lty=1)
abline(h=0,col="black")
lines(site5with4sites[,3],pch=17,col="red",type="b",lty=1)
lines(site5with4sites[,4],pch=18,col="black",type="b",lty=1)
legend(1, 4, legend=c("Cell 2", "Cell 3", "Cell 4"),
       col=c("green","red","black"), pch=c(16,17,18),horiz =TRUE)
mtext("Site A with 3 other sites - non-mediating sites", side=3, line=0,cex=0.5)

```


\newpage

This set of plots show the estimates when the mediating cell type is cell type 4, which has the largest proportion. As expected, performance is better when the cell type has a larger proportion.

```{r, echo=FALSE}

par(mfrow=c(3,2), mai=c(0.1,0.3,0.1,0.3))

plot(site5ONLY.cell4[,4],ylim=c(0,1.5),pch=16,col="blue",xaxt="n",ylab="Theta 2 estimate",xlab="",type="b",lty=1)
abline(h=0.4,col="black")
mtext("Site A by itself - mediating site", side=3, line=0,cex=0.5)

plot(site5ONLY.cell4[,1],ylim=c(-4,4),pch=16,col="green",xaxt="n",ylab="",xlab="",type="b",lty=1)
abline(h=0,col="black")
lines(site5ONLY.cell4[,2],pch=17,col="red",type="b",lty=1)
lines(site5ONLY.cell4[,3],pch=18,col="black",type="b",lty=1)
legend(1, 4, legend=c("Cell 1", "Cell 2", "Cell 3"),
       col=c("green","red","black"), pch=c(16,17,18),horiz =TRUE)
mtext("Site A by itself - non-mediating sites", side=3, line=0,cex=0.5)

plot(site5with9.cell4[,4],ylim=c(0,1.5),pch=16,col="blue",xaxt="n",ylab="Theta 2 estimate",xlab="",type="b",lty=1)
abline(h=0.4,col="black")
mtext("Site A with 1 other site - mediating site", side=3, line=0,cex=0.5)

plot(site5with9.cell4[,1],ylim=c(-4,4),pch=16,col="green",xaxt="n",ylab="",xlab="",type="b",lty=1)
abline(h=0,col="black")
lines(site5with9.cell4[,2],pch=17,col="red",type="b",lty=1)
lines(site5with9.cell4[,3],pch=18,col="black",type="b",lty=1)
legend(1, 4, legend=c("Cell 1", "Cell 2", "Cell 3"),
       col=c("green","red","black"), pch=c(16,17,18),horiz =TRUE)
mtext("Site A with 1 other site - non-mediating sites", side=3, line=0,cex=0.5)

plot(site5with4sites.cell4[,4],ylim=c(0,1.5),pch=16,col="blue",xaxt="n",ylab="Theta 2 estimate",xlab="",type="b",lty=1)
abline(h=0.4,col="black")
mtext("Site A with 3 other sites - mediating site", side=3, line=0,cex=0.5)

plot(site5with4sites.cell4[,1],ylim=c(-4,4),pch=16,col="green",xaxt="n",ylab="",xlab="",type="b",lty=1)
abline(h=0,col="black")
lines(site5with4sites.cell4[,2],pch=17,col="red",type="b",lty=1)
lines(site5with4sites.cell4[,3],pch=18,col="black",type="b",lty=1)
legend(1, 4, legend=c("Cell 1", "Cell 2", "Cell 3"),
       col=c("green","red","black"), pch=c(16,17,18),horiz =TRUE)
mtext("Site A with 3 other sites - non-mediating sites", side=3, line=0,cex=0.5)

```

\newpage

Results in table form, if that's preferable:

```{r, echo=FALSE}
tabmat1 <- rbind(site9cell1.lowvar[1,],site9cell2.lowvar[1,],
        site9cell3.lowvar[1,],site9cell4.lowvar[1,],
site9cell1.lowvar[2,],site9cell2.lowvar[2,],
        site9cell3.lowvar[2,],site9cell4.lowvar[2,],
site9cell1.lowvar[3,],site9cell2.lowvar[3,],
        site9cell3.lowvar[3,],site9cell4.lowvar[3,],
site9cell1.lowvar[4,],site9cell2.lowvar[4,],
        site9cell3.lowvar[4,],site9cell4.lowvar[4,]
)

tabmat2 <- rbind(site5cell1.lowvar[1,],site5cell2.lowvar[1,],
        site5cell3.lowvar[1,],site5cell4.lowvar[1,],
site5cell1.lowvar[2,],site5cell2.lowvar[2,],
        site5cell3.lowvar[2,],site5cell4.lowvar[2,],
site5cell1.lowvar[3,],site5cell2.lowvar[3,],
        site5cell3.lowvar[3,],site5cell4.lowvar[3,],
site5cell1.lowvar[4,],site5cell2.lowvar[4,],
        site5cell3.lowvar[4,],site5cell4.lowvar[4,]
)

tabmat <- round(cbind(tabmat1,tabmat2),2)

kable(tabmat,caption="Theta2 estimates",col.names=c("Cell 1","Cell 2","Cell 3","Cell 4","Cell 1","Cell 2","Cell 3","Cell 4"),row.names = FALSE)%>% 
        kable_styling(latex_options = c("hold_position")) %>% 
        add_header_above(c("Site 1" = 4, "Site 2" = 4)) %>%
        column_spec(1, bold = rep(c(T,F,F,F),4))%>% 
        column_spec(2, bold = rep(c(F,T,F,F),4))%>% 
        column_spec(3, bold = rep(c(F,F,T,F),4))%>% 
        column_spec(4, bold = rep(c(F,F,F,T),4)) %>% 
        column_spec(5, bold = rep(c(T,F,F,F),4))%>% 
        column_spec(6, bold = rep(c(F,T,F,F),4))%>% 
        column_spec(7, bold = rep(c(F,F,T,F),4))%>% 
        column_spec(8, bold = rep(c(F,F,F,T),4)) %>% 
        pack_rows("Initial value case 1: 0 for all theta2",1,4) %>% 
        pack_rows("case 2: 0.2 for all theta2",5,8) %>% 
        pack_rows("case 3: 0.1 non-med, 0.3 med",9,12) %>% 
        pack_rows("case 4: 0 non-med, 0.4 med (true values)",13,16)



```


\newpage

## Bootstrap results

To assess the EM/boostrap procedure, I ran it with only the mediating sites using the true values as initial values.

 
Settings/Notes:

 - N=500
 - To account for multiple testing, the (.025/Ncell$*$Nsite,1-(.025/Ncell$*$Nsite)) quantile is used for bootstrap samples.
 - for EM, max.iter=500 and tol=0.001
 - EM initial values:
     + beta: from TOAST
     + theta: true values
     + tau, sigma: sampled from inverse gamma distribution with mean 0.001 (based on HIRE, which states that variance initial values are sampled from inverse gamma distribution with small mean but does not specify the mean)
     + gamma: true value 0.0004
 - Scripts used: "Lane_Mediation_sim12821_cluster.R" and "mediation_sim_functions_1120.R" (functions script contains EM julia code)


Tables 2 and 3 show results from 1 and 2 sites with mediating effect sizes 0.2 and 0.4. Table 4 summarizes the results from tables 2 and 3 by averaging the non-mediating sites (type 1 error) and the mediating sites (power).

Tables 5 and 6 show results for one CpG site when increasing the number of bootstrap samples from 200 to 1000.

Table 7 summarizes the results from my last report for comparison. Here the initial values were all 0 rather than the true values.


```{r, echo=FALSE}
getres <- function(folder,method,Ncell,Nmed,medpi,Nmedsites,theta){
        mat <- matrix(0,Nmed,Ncell)
        for(i in 1:10){
                new <- read.table(paste0("/Users/andrealane/Dropbox/CelltypeSpecificMediation/Simulation/Results/",folder,"/",method,"_Ncell",Ncell,"_Nmed",Nmed,"_medpi",medpi,"_Nmedsites",Nmedsites,"_theta",theta,"_",i))
        mat <- mat + new
        }
        mat <- apply(mat,2,rev)
        return(mat)
}

matavg <- function(mat,medpi){
        mat <- as.matrix(mat)
        med <- mean(mat[,medpi])
        nonmed <- mean(as.numeric(mat[,-medpi]))
        return(list(med=med,nonmed=nonmed))
}

matavg2 <- function(mat,numsites){
        mat <- as.matrix(mat)
        med <- mean(c(mat[1:numsites,1],mat[numsites+(1:numsites),2],mat[numsites*2+(1:numsites),3],mat[numsites*3+(1:numsites),4]))
        nonmed <- mean(c(mat[1:numsites,-1],mat[numsites+(1:numsites),-2],mat[numsites*2+(1:numsites),-3],mat[numsites*3+(1:numsites),-4]))
        return(list(med=med,nonmed=nonmed))
        
}

```

```{r, echo=FALSE}
### theta 0.4
EMtrue1.1 <- getres("EM_truevals_021621","EM",4,1,1,1,0.4)
EMtrue2.1 <- getres("EM_truevals_021621","EM",4,1,1,2,0.4)

EMtrue1.2 <- getres("EM_truevals_021621","EM",4,1,2,1,0.4)
EMtrue2.2 <- getres("EM_truevals_021621","EM",4,1,2,2,0.4)

EMtrue1.3 <- getres("EM_truevals_021621","EM",4,1,3,1,0.4)
EMtrue2.3 <- getres("EM_truevals_021621","EM",4,1,3,2,0.4)

EMtrue1.4 <- getres("EM_truevals_021621","EM",4,1,4,1,0.4)
EMtrue2.4 <- getres("EM_truevals_021621","EM",4,1,4,2,0.4)

mat.true1 <- rbind(EMtrue1.1,EMtrue1.2,EMtrue1.3,EMtrue1.4)
mat.true2 <- rbind(EMtrue2.1,EMtrue2.2,EMtrue2.3,EMtrue2.4)

### theta 0.2 

EMtrue1.1.2 <- getres("EM_truevals_021621","EM",4,1,1,1,0.2)
EMtrue2.1.2 <- getres("EM_truevals_021621","EM",4,1,1,2,0.2)

EMtrue1.2.2 <- getres("EM_truevals_021621","EM",4,1,2,1,0.2)
EMtrue2.2.2 <- getres("EM_truevals_021621","EM",4,1,2,2,0.2)

EMtrue1.3.2 <- getres("EM_truevals_021621","EM",4,1,3,1,0.2)
EMtrue2.3.2 <- getres("EM_truevals_021621","EM",4,1,3,2,0.2)

EMtrue1.4.2 <- getres("EM_truevals_021621","EM",4,1,4,1,0.2)
EMtrue2.4.2 <- getres("EM_truevals_021621","EM",4,1,4,2,0.2)

mat.true1.2 <- rbind(EMtrue1.1.2,EMtrue1.2.2,EMtrue1.3.2,EMtrue1.4.2)
mat.true2.2 <- rbind(EMtrue2.1.2,EMtrue2.2.2,EMtrue2.3.2,EMtrue2.4.2)

mymat1 <- cbind(mat.true1.2,mat.true1)
mymat2 <- cbind(mat.true2.2,mat.true2)


kable(mymat1,caption="1 site - 200 bootstrap",col.names=c("Cell 1","Cell 2","Cell 3","Cell 4","Cell 1","Cell 2","Cell 3","Cell 4"),row.names = FALSE)%>% 
        kable_styling(latex_options = c("hold_position")) %>% 
        add_header_above(c("Theta = 0.2" = 4, "Theta = 0.4" = 4)) %>%
        column_spec(1, bold = c(T,F,F,F))%>% 
        column_spec(2, bold = c(F,T,F,F))%>% 
        column_spec(3, bold = c(F,F,T,F))%>% 
        column_spec(4, bold = c(F,F,F,T)) %>% 
        column_spec(5, bold = c(T,F,F,F))%>% 
        column_spec(6, bold = c(F,T,F,F))%>% 
        column_spec(7, bold = c(F,F,T,F))%>% 
        column_spec(8, bold = c(F,F,F,T))


kable(mymat2,caption="2 sites - 200 bootstrap",col.names=c("Cell 1","Cell 2","Cell 3","Cell 4","Cell 1","Cell 2","Cell 3","Cell 4"),row.names = FALSE)%>% 
        kable_styling(latex_options = c("hold_position")) %>% 
        add_header_above(c("Theta = 0.2" = 4, "Theta = 0.4" = 4)) %>%
        column_spec(1, bold = c(rep(T,2),rep(F,6)))%>%
        column_spec(2, bold = (c(rep(F,2),rep(T,2),rep(F,4))))%>%
        column_spec(3, bold = (c(rep(F,4),rep(T,2),rep(F,2))))%>%
        column_spec(4, bold = (c(rep(F,6),rep(T,2))))%>%
        column_spec(5, bold = c(rep(T,2),rep(F,6)))%>%
        column_spec(6, bold = (c(rep(F,2),rep(T,2),rep(F,4))))%>%
        column_spec(7, bold = (c(rep(F,4),rep(T,2),rep(F,2))))%>%
        column_spec(8, bold = (c(rep(F,6),rep(T,2)))) %>% 
        row_spec(c(2,4,6),hline_after = TRUE)


```


```{r, echo=FALSE}
## power/type 1 error table

## get avg among mediating and non-mediating sites
mat <- matrix(unlist(c(matavg2(mat.true1.2,1),
matavg2(mat.true2.2,2),
matavg2(mat.true1,1),matavg2(mat.true2,2))),nrow=2,ncol=4)

mat <- round(mat/1000,3)

rownames(mat) <- c("Power","Type 1 error")

kable(mat,caption="Average across mediating and nonmediating sites/cell types - 200 bootstrap",row.names = TRUE)%>% 
        kable_styling(latex_options = c("hold_position")) %>%
        add_header_above(c(" " = 1,"Theta = 0.2" = 2,"Theta = 0.4" = 2)) %>%
        add_header_above(c(" " = 1,"1 site" = 1,"2 sites" = 1,"1 site" = 1,"2 sites" = 1))




```


```{r, echo=FALSE}
### 1000 bootstrap

EMtrue1.1.4 <- getres("1000Boot_truevals","EM",4,1,1,1,0.4)
EMtrue1.2.4 <- getres("1000Boot_truevals","EM",4,1,2,1,0.4)
EMtrue1.3.4 <- getres("1000Boot_truevals","EM",4,1,3,1,0.4)
EMtrue1.4.4 <- getres("1000Boot_truevals","EM",4,1,4,1,0.4)

EMtrue1.1.2 <- getres("1000Boot_truevals","EM",4,1,1,1,0.2)
EMtrue1.2.2 <- getres("1000Boot_truevals","EM",4,1,2,1,0.2)
EMtrue1.3.2 <- getres("1000Boot_truevals","EM",4,1,3,1,0.2)
EMtrue1.4.2 <- getres("1000Boot_truevals","EM",4,1,4,1,0.2)

mat.true1 <- rbind(EMtrue1.1.4,EMtrue1.2.4,EMtrue1.3.4,EMtrue1.4.4)
mat.true2 <- rbind(EMtrue1.1.2,EMtrue1.2.2,EMtrue1.3.2,EMtrue1.4.2)

mymat <- cbind(mat.true2,mat.true1)

kable(mymat,caption="1 site - 1000 bootstrap",col.names=c("Cell 1","Cell 2","Cell 3","Cell 4","Cell 1","Cell 2","Cell 3","Cell 4"),row.names = FALSE)%>% 
        kable_styling(latex_options = c("hold_position")) %>% 
        add_header_above(c("Theta = 0.2" = 4, "Theta = 0.4" = 4)) %>%
        column_spec(1, bold = c(T,F,F,F))%>% 
        column_spec(2, bold = c(F,T,F,F))%>% 
        column_spec(3, bold = c(F,F,T,F))%>% 
        column_spec(4, bold = c(F,F,F,T)) %>% 
        column_spec(5, bold = c(T,F,F,F))%>% 
        column_spec(6, bold = c(F,T,F,F))%>% 
        column_spec(7, bold = c(F,F,T,F))%>% 
        column_spec(8, bold = c(F,F,F,T))

```

```{r, echo=FALSE}

mat <- matrix(unlist(c(matavg2(mat.true2,1),
matavg2(mat.true1,1))),nrow=2,ncol=2)

mat <- round(mat/1000,3)

rownames(mat) <- c("Power","Type 1 error")

kable(mat,caption="Average across mediating and nonmediating sites/cell types - 1000 bootstrap",row.names = TRUE)%>% 
        kable_styling(latex_options = c("hold_position")) %>%
        add_header_above(c(" " = 1,"Theta = 0.2" = 1,"Theta = 0.4" = 1))


```


```{r, echo=FALSE}
EM1.1 <- getres("CompareSiteandCell_020921","EM",4,1,1,1,0.4)
EM2.1 <- getres("CompareSiteandCell_020921","EM",4,1,1,2,0.4)
EM3.1 <- getres("CompareSiteandCell_020921","EM",4,1,1,3,0.4)

EM1.2 <- getres("CompareSiteandCell_020921","EM",4,1,2,1,0.4)
EM2.2 <- getres("CompareSiteandCell_020921","EM",4,1,2,2,0.4)
EM3.2 <- getres("CompareSiteandCell_020921","EM",4,1,2,3,0.4)

EM1.3 <- getres("CompareSiteandCell_020921","EM",4,1,3,1,0.4)
EM2.3 <- getres("CompareSiteandCell_020921","EM",4,1,3,2,0.4)
EM3.3 <- getres("CompareSiteandCell_020921","EM",4,1,3,3,0.4)

EM1.4 <- getres("CompareSiteandCell_020921","EM",4,1,4,1,0.4)
EM2.4 <- getres("CompareSiteandCell_020921","EM",4,1,4,2,0.4)
EM3.4 <- getres("CompareSiteandCell_020921","EM",4,1,4,3,0.4)

EM1 <- rbind(EM1.1,EM1.2,EM1.3,EM1.4)
EM2 <- rbind(EM2.1,EM2.2,EM2.3,EM2.4)
EM3 <- rbind(EM3.1,EM3.2,EM3.3,EM3.4)

mat <- matrix(unlist(c(matavg2(EM1,1),
matavg2(EM2,2),matavg2(EM3,3))),nrow=2,ncol=3)

mat <- round(mat/1000,3)

rownames(mat) <- c("Power","Type 1 error")

kable(mat,caption="Average across mediating and nonmediating sites/cell types - 0s as initial values (theta=0.4)",row.names = TRUE)%>% 
        kable_styling(latex_options = c("hold_position")) %>%
        add_header_above(c(" " = 1,"1 site" = 1,"2 sites" = 1,"3 sites" = 1))


```

\newpage

## Next steps

 - Find a way to get initial values (i.e. try TOAST M ~ Y)
 - Increase variance
 - Use bootstrap with TCA estimates
 - Add covariate(s)
